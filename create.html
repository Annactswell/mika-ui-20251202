<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mika Studio | Create Magic</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'acid-yellow': '#DFFF00',
                        'jungle-green': '#00684A',
                        'soft-cream': '#FFFDF5',
                        'monster-purple': '#9D4EDD',
                        'hot-pink': '#FF0099',
                    },
                    fontFamily: {
                        'display': ['"Poppins"', 'sans-serif'],
                        'body': ['"Inter"', 'sans-serif'],
                    },
                    boxShadow: {
                        'hard': '5px 5px 0px 0px #000000',
                        'hard-hover': '2px 2px 0px 0px #000000',
                        'card': '8px 8px 0px 0px #000000',
                        'inner-hard': 'inset 4px 4px 0px 0px #000000',
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #FFFDF5; border-left: 3px solid black; }
        ::-webkit-scrollbar-thumb { background: #00684A; border: 3px solid black; }
        ::-webkit-scrollbar-thumb:hover { background: #DFFF00; }

        .doodle-bg {
            background-image: radial-gradient(#000 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .brutal-btn { transition: all 0.1s ease; }
        .brutal-btn:active { transform: translate(4px, 4px); box-shadow: 0px 0px 0px 0px #000000; }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #DFFF00;
            border: 3px solid black;
            cursor: pointer;
            margin-top: -10px; 
            box-shadow: 2px 2px 0px 0px #000000;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: #000;
            border-radius: 4px;
            border: 2px solid black;
        }

        /* Aspect Ratio Radio Button Logic */
        .ratio-radio:checked + label {
            background-color: #9D4EDD;
            color: white;
            box-shadow: 2px 2px 0px 0px #000000;
            transform: translate(2px, 2px);
        }
        
        /* Style/Template Radio Button Logic */
        .style-radio:checked + label,
        .template-radio:checked + label {
            border-color: #000;
            background-color: #DFFF00;
        }
        .style-radio:checked + label .check-icon,
        .template-radio:checked + label .check-icon {
            opacity: 1;
        }

        .loading-overlay {
            background-image: repeating-linear-gradient(
                45deg,
                #000 0,
                #000 10px,
                #DFFF00 10px,
                #DFFF00 20px
            );
            background-size: 200% 200%;
            animation: barberpole 2s linear infinite;
        }
        
        @keyframes barberpole {
            100% { background-position: 100% 100%; }
        }
    </style>
</head>
<body class="bg-soft-cream font-body text-black overflow-x-hidden h-screen flex flex-col">

    <!-- Top Navigation -->
    <nav class="border-b-4 border-black bg-acid-yellow shrink-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo -->
                <a href="index.html" class="flex items-center gap-2 cursor-pointer group hover:scale-105 transition-transform">
                    <span class="font-display text-5xl tracking-widest uppercase italic" style="text-shadow: 4px 4px 0px #FFF;">Mika</span>
                </a>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-8 font-bold text-lg">
                    <a href="templates.html" class="hover:text-jungle-green hover:underline decoration-4 decoration-jungle-green underline-offset-4">Templates</a>
                    <a href="gallery.html" class="hover:text-jungle-green hover:underline decoration-4 decoration-jungle-green underline-offset-4">Gallery</a>
                    <a href="models.html" class="hover:text-jungle-green hover:underline decoration-4 decoration-jungle-green underline-offset-4">Models</a>
                    <a href="challenges.html" class="hover:text-jungle-green hover:underline decoration-4 decoration-jungle-green underline-offset-4">Challenges</a>
                    <a href="library.html" class="hover:text-jungle-green hover:underline decoration-4 decoration-jungle-green underline-offset-4">Library</a>
                    <div class="flex items-center gap-2 bg-white border-2 border-black rounded-full px-3 py-1 shadow-hard-hover">
                        <i data-lucide="coins" class="w-5 h-5 text-yellow-500 fill-current"></i>
                        <span class="font-bold">50</span>
                    </div>
                    <a href="profile.html" class="w-10 h-10 rounded-full bg-monster-purple border-2 border-black overflow-hidden hover:scale-110 transition-transform">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full object-cover">
                    </a>
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button id="mobile-menu-btn" class="p-2 border-2 border-black bg-white shadow-hard rounded-md">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="fixed inset-0 bg-acid-yellow z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col justify-center items-center gap-8 md:hidden">
        <!-- Close Button -->
        <button id="close-menu-btn" class="absolute top-6 right-6 p-2 border-2 border-black bg-white shadow-hard rounded-md">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>

        <!-- Links -->
        <a href="templates.html" class="font-display text-4xl font-bold text-black hover:text-jungle-green hover:underline decoration-4 underline-offset-8">Templates</a>
        <a href="gallery.html" class="font-display text-4xl font-bold text-black hover:text-jungle-green hover:underline decoration-4 underline-offset-8">Gallery</a>
        <a href="models.html" class="font-display text-4xl font-bold text-black hover:text-jungle-green hover:underline decoration-4 underline-offset-8">Models</a>
        <a href="challenges.html" class="font-display text-4xl font-bold text-black hover:text-jungle-green hover:underline decoration-4 underline-offset-8">Challenges</a>
        <a href="library.html" class="font-display text-4xl font-bold text-black hover:text-jungle-green hover:underline decoration-4 underline-offset-8">Library</a>
        <a href="blog.html" class="font-display text-4xl font-bold text-black hover:text-jungle-green hover:underline decoration-4 underline-offset-8">Blog</a>

        <!-- Actions -->
        <div class="flex flex-col gap-4 mt-4">
             <a href="create.html" class="brutal-btn bg-jungle-green text-acid-yellow px-8 py-3 rounded-full border-2 border-black shadow-hard text-xl font-bold transform hover:-translate-y-1 text-center">
                Create Now
            </a>
            <a href="profile.html" class="brutal-btn bg-white text-black px-8 py-3 rounded-full border-2 border-black shadow-hard text-xl font-bold text-center">
                My Profile
            </a>
        </div>
    </div>

    <!-- Mobile Settings Toggle FAB -->
    <button id="openSettingsBtn" class="md:hidden fixed bottom-6 right-6 z-30 w-16 h-16 bg-jungle-green text-acid-yellow border-4 border-black rounded-full shadow-hard flex items-center justify-center animate__animated animate__bounceIn hover:scale-110 transition-transform">
        <i data-lucide="sliders-horizontal" class="w-8 h-8"></i>
    </button>

    <!-- Main Workspace -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- Left Sidebar: Controls (Scrollable) -->
        <aside id="settingsPanel" class="fixed inset-x-0 bottom-0 h-[85vh] md:static md:h-auto w-full md:w-[450px] bg-white border-t-4 md:border-t-0 md:border-r-4 border-black p-6 overflow-y-auto z-40 shadow-[0px_-4px_0px_0px_rgba(0,0,0,1)] md:shadow-[4px_0px_0px_0px_rgba(0,0,0,0.1)] transform translate-y-full md:translate-y-0 transition-transform duration-300 rounded-t-3xl md:rounded-none">
            
            <!-- Mobile Drag Handle / Header -->
            <div class="md:hidden flex flex-col items-center mb-6">
                <div class="w-16 h-1.5 bg-gray-300 rounded-full mb-6"></div>
                <div class="flex justify-between items-center w-full">
                    <h2 class="font-display text-2xl">Studio Controls</h2>
                    <button id="closeSettingsBtn" class="p-2 border-2 border-black rounded-lg hover:bg-gray-100">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <div class="space-y-8">

                <!-- Model Selector -->
                <div class="space-y-2">
                    <label class="font-display text-xl uppercase">Model Checkpoint</label>
                    <div class="relative" id="customSelectContainer">
                        <!-- Trigger -->
                        <button id="modelSelectTrigger" class="w-full p-4 bg-white border-4 border-black rounded-xl font-bold text-lg flex justify-between items-center shadow-hard active:shadow-none active:translate-x-1 active:translate-y-1 transition-all text-left">
                            <span id="selectedModelText">Mika Realism V5 (Default)</span>
                            <i data-lucide="chevron-down" class="w-6 h-6"></i>
                        </button>

                        <!-- Dropdown List -->
                        <div id="modelDropdown" class="hidden absolute top-full left-0 w-full bg-white border-4 border-black rounded-xl mt-2 shadow-hard z-50 overflow-hidden">
                            <div class="max-h-60 overflow-y-auto">
                                <div class="model-option p-4 hover:bg-acid-yellow cursor-pointer border-b-2 border-black last:border-0 font-bold flex items-center gap-2" data-value="Mika Realism V5 (Default)">
                                    <span class="w-3 h-3 rounded-full bg-jungle-green"></span> Mika Realism V5 (Default)
                                </div>
                                <div class="model-option p-4 hover:bg-acid-yellow cursor-pointer border-b-2 border-black last:border-0 font-bold flex items-center gap-2" data-value="Niji Electric [Anime]">
                                    <span class="w-3 h-3 rounded-full bg-monster-purple"></span> Niji Electric [Anime]
                                </div>
                                <div class="model-option p-4 hover:bg-acid-yellow cursor-pointer border-b-2 border-black last:border-0 font-bold flex items-center gap-2" data-value="Poly-Perfect 3D">
                                    <span class="w-3 h-3 rounded-full bg-blue-500"></span> Poly-Perfect 3D
                                </div>
                                <div class="model-option p-4 hover:bg-acid-yellow cursor-pointer border-b-2 border-black last:border-0 font-bold flex items-center gap-2" data-value="Retro Vaporwave">
                                    <span class="w-3 h-3 rounded-full bg-hot-pink"></span> Retro Vaporwave
                                </div>
                                <div class="model-option p-4 hover:bg-acid-yellow cursor-pointer border-b-2 border-black last:border-0 font-bold flex items-center gap-2" data-value="Claymation Studio">
                                    <span class="w-3 h-3 rounded-full bg-orange-500"></span> Claymation Studio
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Prompt Input -->
                <div class="space-y-2">
                    <div class="flex justify-between items-end">
                        <label class="font-display text-xl uppercase">Prompt</label>
                        <div class="flex gap-2">
                            <button class="w-10 h-10 rounded-lg border-2 border-black bg-monster-purple text-white hover:bg-black shadow-hard-hover active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all flex items-center justify-center" onclick="magicExpand()" title="Magic Expand">
                                <i data-lucide="sparkles" class="w-5 h-5"></i>
                            </button>
                            <button class="w-10 h-10 rounded-lg border-2 border-black bg-gray-200 hover:bg-acid-yellow shadow-hard-hover active:shadow-none active:translate-x-[2px] active:translate-y-[2px] transition-all flex items-center justify-center" onclick="randomizePrompt()" title="Random Prompt">
                                <i data-lucide="dices" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <textarea id="promptInput" class="w-full h-32 p-4 bg-soft-cream border-4 border-black rounded-xl font-bold text-lg resize-none focus:outline-none focus:ring-4 focus:ring-acid-yellow/50 shadow-inner-hard" placeholder="Describe your electric dream..."></textarea>
                </div>

                <!-- Image Reference Upload -->
                <div class="space-y-2">
                    <label class="font-display text-xl uppercase flex items-center gap-2">
                        Ref Images
                        <span class="text-xs bg-black text-white px-2 py-0.5 rounded-full" id="refCount">Optional</span>
                    </label>
                    <div id="dropZone" class="border-4 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-black hover:bg-gray-50 transition-colors cursor-pointer group relative">
                        <input type="file" id="fileInput" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div id="uploadPlaceholder">
                            <i data-lucide="image-up" class="w-8 h-8 mx-auto mb-2 text-gray-400 group-hover:text-black"></i>
                            <p class="font-bold text-sm text-gray-500 group-hover:text-black">Drop images here or click</p>
                        </div>
                        <!-- Thumbnails Container -->
                        <div id="thumbnailsGrid" class="hidden grid grid-cols-3 gap-2 mt-2 pointer-events-none"></div>
                    </div>
                </div>

                <!-- Settings Grid -->
                <div class="grid grid-cols-1 gap-6">
                    
                    <!-- Aspect Ratio -->
                    <div>
                        <label class="font-display text-lg uppercase block mb-3">Aspect Ratio</label>
                        <div class="relative">
                            <select id="aspectRatioSelect" class="w-full p-4 bg-white border-4 border-black rounded-xl font-bold text-lg appearance-none focus:outline-none focus:ring-4 focus:ring-acid-yellow/50 shadow-hard cursor-pointer">
                                <option value="1:1">1:1 (Square)</option>
                                <option value="16:9">16:9 (Landscape)</option>
                                <option value="9:16">9:16 (Portrait)</option>
                                <option value="3:4">3:4 (Portrait)</option>
                                <option value="4:3">4:3 (Landscape)</option>
                                <option value="2:3">2:3 (Classic Portrait)</option>
                                <option value="3:2">3:2 (Classic Landscape)</option>
                                <option value="5:4">5:4 (Medium Format)</option>
                                <option value="4:5">4:5 (Instagram Portrait)</option>
                                <option value="21:9">21:9 (Ultrawide)</option>
                            </select>
                            <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none">
                                <i data-lucide="chevron-down" class="w-6 h-6"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Template Selection -->
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <label class="font-display text-lg uppercase">Template</label>
                            <a href="templates.html" class="text-xs font-bold underline hover:text-jungle-green">View All</a>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Template: None -->
                            <div class="relative">
                                <input type="radio" name="template" id="template-none" class="hidden template-radio" checked data-prompt="">
                                <label for="template-none" class="block border-4 border-black rounded-lg p-2 cursor-pointer bg-white hover:-translate-y-1 transition-transform h-24 group flex flex-col items-center justify-center text-center shadow-hard-hover">
                                    <i data-lucide="ban" class="w-6 h-6 mb-1 text-gray-400 group-hover:text-black"></i>
                                    <span class="font-bold text-xs">None</span>
                                </label>
                            </div>
                            <!-- Template: Cyberpunk -->
                            <div class="relative">
                                <input type="radio" name="template" id="template-1" class="hidden template-radio" data-prompt="Futuristic cyberpunk city, neon lights, high contrast, rain slicked streets, detailed environment, 8k resolution">
                                <label for="template-1" class="block border-4 border-black rounded-lg p-0 cursor-pointer bg-white hover:-translate-y-1 transition-transform overflow-hidden relative h-24 group shadow-hard-hover">
                                    <img src="https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" class="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-opacity">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                                    <span class="absolute bottom-2 left-2 text-white font-bold text-xs z-10">Cyberpunk</span>
                                    <div class="check-icon absolute top-1 right-1 bg-acid-yellow rounded-full p-0.5 opacity-0 transition-opacity">
                                        <i data-lucide="check" class="w-3 h-3 text-black"></i>
                                    </div>
                                </label>
                            </div>
                            <!-- Template: Anime -->
                            <div class="relative">
                                <input type="radio" name="template" id="template-2" class="hidden template-radio" data-prompt="Anime style illustration, vibrant colors, highly detailed, character portrait, studio ghibli inspired, soft lighting">
                                <label for="template-2" class="block border-4 border-black rounded-lg p-0 cursor-pointer bg-white hover:-translate-y-1 transition-transform overflow-hidden relative h-24 group shadow-hard-hover">
                                    <img src="https://images.unsplash.com/photo-1563089145-599997674d42?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" class="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-opacity">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                                    <span class="absolute bottom-2 left-2 text-white font-bold text-xs z-10">Anime</span>
                                    <div class="check-icon absolute top-1 right-1 bg-acid-yellow rounded-full p-0.5 opacity-0 transition-opacity">
                                        <i data-lucide="check" class="w-3 h-3 text-black"></i>
                                    </div>
                                </label>
                            </div>
                             <!-- Template: 3D Render -->
                             <div class="relative">
                                <input type="radio" name="template" id="template-3" class="hidden template-radio" data-prompt="3D abstract render, glass dispersion, iridescent materials, octane render, ray tracing, minimal composition, 4k">
                                <label for="template-3" class="block border-4 border-black rounded-lg p-0 cursor-pointer bg-white hover:-translate-y-1 transition-transform overflow-hidden relative h-24 group shadow-hard-hover">
                                    <img src="https://images.unsplash.com/photo-1618172193763-c511deb635ca?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" class="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-opacity">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                                    <span class="absolute bottom-2 left-2 text-white font-bold text-xs z-10">3D Render</span>
                                    <div class="check-icon absolute top-1 right-1 bg-acid-yellow rounded-full p-0.5 opacity-0 transition-opacity">
                                        <i data-lucide="check" class="w-3 h-3 text-black"></i>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Sliders Group -->
                    <div class="space-y-6">

                        <!-- Batch Count -->
                        <div>
                            <div class="flex justify-between mb-1">
                                 <label class="font-display text-sm uppercase">Batch Size</label>
                                 <span class="font-bold text-sm" id="batchValue">1</span>
                            </div>
                            <input type="range" min="1" max="4" value="1" step="1" class="w-full" id="batchSlider">
                            <div class="flex justify-between text-xs font-bold text-gray-400 mt-1">
                                <span>1</span><span>2</span><span>3</span><span>4</span>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Generate Button -->
                <div class="pt-4">
                    <button id="generateBtn" class="brutal-btn w-full bg-jungle-green text-acid-yellow font-display text-2xl py-4 rounded-xl border-4 border-black shadow-hard hover:shadow-hard-hover hover:bg-acid-yellow hover:text-black flex items-center justify-center gap-3">
                        <i data-lucide="zap" class="w-6 h-6 fill-current"></i>
                        GENERATE
                        <span class="text-sm font-sans bg-black/20 px-2 py-1 rounded">-2 Credits</span>
                    </button>
                </div>

            </div>
        </aside>

        <!-- Right Area: Canvas / Result -->
        <main class="flex-1 bg-doodle-bg relative flex flex-col">
            
            <!-- Toolbar -->
            <div class="h-16 border-b-4 border-black bg-white flex items-center justify-between px-6">
                <div class="font-bold text-gray-400 hidden md:block"># Session: 8X29A</div>
                
                <!-- Simplified Toolbar (Removed Painting Tools) -->
                <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1 border-2 border-black opacity-50 cursor-not-allowed" title="Select an image to edit">
                    <button class="p-2 rounded" disabled><i data-lucide="move" class="w-5 h-5"></i></button>
                    <button class="p-2 rounded" disabled><i data-lucide="paintbrush" class="w-5 h-5"></i></button>
                    <button class="p-2 rounded" disabled><i data-lucide="eraser" class="w-5 h-5"></i></button>
                </div>

                <div class="flex gap-4">
                     <button class="p-2 hover:bg-gray-100 rounded border-2 border-transparent hover:border-black transition-all" title="Download">
                        <i data-lucide="download" class="w-5 h-5"></i>
                     </button>
                     <button class="p-2 hover:bg-gray-100 rounded border-2 border-transparent hover:border-black transition-all" title="Share">
                        <i data-lucide="share-2" class="w-5 h-5"></i>
                     </button>
                </div>
            </div>

            <!-- Main Viewport -->
            <div class="flex-1 p-8 flex items-center justify-center overflow-hidden relative" id="canvasArea">
                
                <!-- Placeholder State -->
                <div id="placeholderState" class="text-center animate__animated animate__fadeIn">
                    <div class="w-48 h-48 bg-soft-cream border-4 border-black rounded-full flex items-center justify-center mx-auto mb-6 shadow-card rotate-3">
                        <i data-lucide="image-plus" class="w-20 h-20 text-gray-300"></i>
                    </div>
                    <h2 class="font-display text-4xl text-gray-400 mb-2">Canvas Empty</h2>
                    <p class="font-bold text-gray-400">Enter a prompt and hit Generate to start cooking.</p>
                </div>

                <!-- Loading State (Hidden by default) -->
                <div id="loadingState" class="hidden absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center">
                    <div class="w-64 h-8 border-4 border-black rounded-full overflow-hidden bg-white shadow-hard">
                        <div class="h-full w-full loading-overlay"></div>
                    </div>
                    <p class="font-display text-2xl mt-6 animate-pulse">Constructing Pixels...</p>
                    <p class="font-bold text-gray-500 mt-2" id="loadingText">Warming up GPUs...</p>
                </div>

                <!-- Result Grid -->
                <div id="resultContainer" class="hidden w-full h-full flex items-center justify-center">
                    <!-- Single Image View (Default) -->
                    <div id="singleResult" class="relative group max-w-full max-h-full transition-all duration-300">
                        <div class="bg-white p-2 border-4 border-black shadow-card transform rotate-1 hover:rotate-0 transition-transform">
                            <img id="resultImage" src="" class="max-h-[70vh] max-w-full object-contain border-2 border-black">
                        </div>
                        <!-- Actions -->
                        <div class="absolute -bottom-6 -right-6 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10">
                             <button class="brutal-btn bg-acid-yellow border-2 border-black px-4 py-2 font-bold rounded-lg shadow-hard text-sm hover:bg-black hover:text-white">
                                Upscale
                             </button>
                             <button class="brutal-btn bg-white border-2 border-black px-4 py-2 font-bold rounded-lg shadow-hard text-sm hover:bg-black hover:text-white">
                                Variations
                             </button>
                             <button class="brutal-btn bg-white border-2 border-black px-4 py-2 font-bold rounded-lg shadow-hard text-sm hover:bg-acid-yellow hover:text-black" onclick="alert('Saved to Library!')">
                                <i data-lucide="bookmark" class="w-4 h-4 inline-block mr-1"></i> Save
                             </button>
                             <button onclick="goToRefine()" class="brutal-btn bg-monster-purple text-white border-2 border-black px-4 py-2 font-bold rounded-lg shadow-hard text-sm hover:bg-black">
                                Edit / Refine
                             </button>
                        </div>
                    </div>

                    <!-- Batch Grid View (Hidden initially) -->
                    <div id="batchGrid" class="hidden grid-cols-2 gap-4 w-full max-w-4xl h-full p-4 overflow-y-auto">
                        <!-- Items injected via JS -->
                    </div>
                </div>

            </div>

            <!-- History Strip (Bottom) -->
            <div class="h-32 border-t-4 border-black bg-white overflow-x-auto p-4 flex gap-4 items-center shrink-0">
                <div class="text-xs font-bold uppercase w-16 text-center text-gray-400 leading-tight">Recent<br>Gens</div>
                <!-- History Item -->
                <div class="w-20 h-20 border-2 border-black rounded-lg overflow-hidden shrink-0 cursor-pointer hover:opacity-80">
                    <img src="https://images.unsplash.com/photo-1578301978693-85fa9c0320b9?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" class="w-full h-full object-cover">
                </div>
                <div class="w-20 h-20 border-2 border-black rounded-lg overflow-hidden shrink-0 cursor-pointer hover:opacity-80">
                    <img src="https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" class="w-full h-full object-cover">
                </div>
                 <div class="w-20 h-20 border-2 border-black rounded-lg overflow-hidden shrink-0 cursor-pointer hover:opacity-80 opacity-50">
                    <div class="w-full h-full bg-gray-100 flex items-center justify-center">
                        <i data-lucide="history" class="w-6 h-6 text-gray-300"></i>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        lucide.createIcons();

        // Mobile Menu Toggle Logic
        const menuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeBtn = document.getElementById('close-menu-btn');

        function toggleMenu() {
            mobileMenu.classList.toggle('translate-x-full');
        }

        if(menuBtn) menuBtn.addEventListener('click', toggleMenu);
        if(closeBtn) closeBtn.addEventListener('click', toggleMenu);

        const prompts = [
            "A futuristic cyberpunk street food vendor serving neon ramen in the rain",
            "A portrait of a robotic cat with emerald eyes in the style of oil painting",
            "Isometric 3D render of a cozy cottage in a magical forest",
            "Synthwave sunset over a grid landscape with mountains",
            "Steampunk airship floating above Victorian London clouds"
        ];

        const loadingTexts = [
            "Warming up GPUs...",
            "Consulting the Oracle...",
            "Mixing colors...",
            "Applying magic dust...",
            "Almost there..."
        ];

        const demoImages = [
            "https://images.unsplash.com/photo-1618172193763-c511deb635ca?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80",
            "https://images.unsplash.com/photo-1563089145-599997674d42?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80",
            "https://images.unsplash.com/photo-1549490349-8643362247b5?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80",
            "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80"
        ];

        function randomizePrompt() {
            const input = document.getElementById('promptInput');
            input.value = prompts[Math.floor(Math.random() * prompts.length)];
        }

        // Batch Slider Logic
        const batchSlider = document.getElementById('batchSlider');
        const batchValue = document.getElementById('batchValue');
        batchSlider.addEventListener('input', (e) => {
            batchValue.innerText = e.target.value;
        });

        const generateBtn = document.getElementById('generateBtn');
        const placeholderState = document.getElementById('placeholderState');
        const loadingState = document.getElementById('loadingState');
        const resultContainer = document.getElementById('resultContainer');
        const singleResult = document.getElementById('singleResult');
        const batchGrid = document.getElementById('batchGrid');
        const resultImage = document.getElementById('resultImage');
        const loadingText = document.getElementById('loadingText');

        generateBtn.addEventListener('click', () => {
            // Start Generation UI Flow
            placeholderState.classList.add('hidden');
            resultContainer.classList.add('hidden');
            loadingState.classList.remove('hidden');
            
            // Cycle loading text
            let textIdx = 0;
            const textInterval = setInterval(() => {
                textIdx = (textIdx + 1) % loadingTexts.length;
                loadingText.innerText = loadingTexts[textIdx];
            }, 800);

            // Simulate API delay
            setTimeout(() => {
                clearInterval(textInterval);
                loadingState.classList.add('hidden');
                resultContainer.classList.remove('hidden');
                
                const count = parseInt(batchSlider.value);
                
                if (count === 1) {
                    // Single View
                    batchGrid.classList.add('hidden');
                    batchGrid.classList.remove('grid');
                    singleResult.classList.remove('hidden');
                    
                    // Select a random image and set it
                    const selectedImg = demoImages[Math.floor(Math.random() * demoImages.length)];
                    resultImage.src = selectedImg;
                    resultImage.dataset.url = selectedImg; // Store for navigation
                    
                    singleResult.classList.add('animate__animated', 'animate__zoomIn');
                } else {
                    // Batch View
                    singleResult.classList.add('hidden');
                    batchGrid.classList.remove('hidden');
                    batchGrid.classList.add('grid');
                    batchGrid.innerHTML = ''; // Clear prev
                    
                    for(let i=0; i<count; i++) {
                        const imgUrl = demoImages[i % demoImages.length];
                        const item = document.createElement('div');
                        item.className = 'bg-white p-2 border-4 border-black shadow-card hover:-translate-y-1 transition-transform animate__animated animate__fadeInUp group relative';
                        item.style.animationDelay = `${i * 0.1}s`;
                        // Batch item with actions
                        item.innerHTML = `
                            <div class="relative">
                                <img src="${imgUrl}" class="w-full h-48 object-cover border-2 border-black mb-2">
                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                    <button onclick="goToRefine('${imgUrl}')" class="bg-monster-purple text-white px-3 py-1 rounded-lg font-bold text-xs border-2 border-black hover:scale-110 transition-transform">
                                        <i data-lucide="paintbrush" class="w-4 h-4"></i> Edit
                                    </button>
                                </div>
                            </div>
                            <div class="flex justify-between">
                                <button class="text-xs font-bold bg-acid-yellow border border-black px-2 py-1 rounded hover:bg-black hover:text-white">U${i+1}</button>
                                <button class="text-xs font-bold bg-white border border-black px-2 py-1 rounded hover:bg-black hover:text-white">V${i+1}</button>
                            </div>
                        `;
                        batchGrid.appendChild(item);
                    }
                    lucide.createIcons(); // Re-init icons for new elements
                }
                
            }, 3000);
        });

        function goToRefine(url) {
            // If url is passed, use it, otherwise use the main result image
            const targetUrl = url || document.getElementById('resultImage').dataset.url;
            if (targetUrl) {
                // Navigate to refine page with image URL param
                window.location.href = `refine.html?img=${encodeURIComponent(targetUrl)}`;
            }
        }

        // --- New Features Logic ---

        // 1. Mobile Settings Sheet
        const settingsPanel = document.getElementById('settingsPanel');
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');

        function toggleSettings() {
            settingsPanel.classList.toggle('translate-y-full');
        }

        if(openSettingsBtn) openSettingsBtn.addEventListener('click', toggleSettings);
        if(closeSettingsBtn) closeSettingsBtn.addEventListener('click', toggleSettings);

        // 3. Magic Expand (Simulation)
        function magicExpand() {
            const input = document.getElementById('promptInput');
            const currentVal = input.value.trim();
            
            if (!currentVal) {
                input.value = "A majestic lion wearing a space suit, nebula background, cinematic lighting, 8k, octane render, highly detailed fur";
                return;
            }

            // Simulate expansion by appending keywords
            const magicWords = ", cinematic lighting, 8k resolution, detailed texture, masterpiece, trending on artstation, dramatic atmosphere";
            input.value = currentVal + magicWords;
            
            // Visual feedback
            const btn = document.querySelector('button[onclick="magicExpand()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> Expanded!';
            setTimeout(() => {
                btn.innerHTML = originalText;
                lucide.createIcons();
            }, 1500);
        }

        // 4. Custom Model Selector Logic
        const modelTrigger = document.getElementById('modelSelectTrigger');
        const modelDropdown = document.getElementById('modelDropdown');
        const selectedModelText = document.getElementById('selectedModelText');
        const modelOptions = document.querySelectorAll('.model-option');

        // Toggle Dropdown
        if(modelTrigger) {
            modelTrigger.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent triggering document click
                modelDropdown.classList.toggle('hidden');
                
                // Rotate chevron
                const icon = modelTrigger.querySelector('svg');
                if(icon) {
                    icon.style.transition = 'transform 0.2s';
                    if(modelDropdown.classList.contains('hidden')) {
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
            });
        }

        // Select Option
        modelOptions.forEach(option => {
            option.addEventListener('click', () => {
                const value = option.getAttribute('data-value');
                // Update Trigger Text
                selectedModelText.innerText = value;
                
                // Close Dropdown
                modelDropdown.classList.add('hidden');
                const icon = modelTrigger.querySelector('svg');
                if(icon) icon.style.transform = 'rotate(0deg)';
                
                // Visual Feedback (Optional: Flash yellow)
                modelTrigger.classList.add('bg-acid-yellow');
                setTimeout(() => {
                    modelTrigger.classList.remove('bg-acid-yellow');
                    modelTrigger.classList.add('bg-white');
                }, 300);
            });
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (modelTrigger && !modelTrigger.contains(e.target) && !modelDropdown.contains(e.target)) {
                modelDropdown.classList.add('hidden');
                // Reset chevron if it exists (might be null if lucide hasn't run yet, but usually fine)
                const icon = modelTrigger.querySelector('svg');
                if(icon) icon.style.transform = 'rotate(0deg)';
            }
        });


        // 5. Multi-Image Reference Logic
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const thumbnailsGrid = document.getElementById('thumbnailsGrid');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const refCountLabel = document.getElementById('refCount');
        
        let refImages = [];

        function updateThumbnails() {
            thumbnailsGrid.innerHTML = '';
            refImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'relative aspect-square border-2 border-black rounded-lg overflow-hidden group pointer-events-auto';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-full object-cover">
                        <button onclick="removeRefImage(event, ${index})" class="absolute top-0.5 right-0.5 bg-red-500 text-white p-0.5 rounded hover:bg-red-600 z-20">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    `;
                    thumbnailsGrid.appendChild(div);
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            });

            if (refImages.length === 0) {
                refCountLabel.innerText = 'Optional';
            } else {
                refCountLabel.innerText = `${refImages.length}/9`;
            }

            if (refImages.length > 0) {
                uploadPlaceholder.classList.add('hidden');
                dropZone.classList.remove('p-6');
                dropZone.classList.add('p-2');
                thumbnailsGrid.classList.remove('hidden');
            } else {
                uploadPlaceholder.classList.remove('hidden');
                dropZone.classList.add('p-6');
                dropZone.classList.remove('p-2');
                thumbnailsGrid.classList.add('hidden');
            }
        }

        function handleFiles(files) {
            const remaining = 9 - refImages.length;
            if (remaining <= 0) {
                alert("Maximum 9 images allowed.");
                return;
            }

            const newFiles = Array.from(files).slice(0, remaining);
            refImages = [...refImages, ...newFiles];
            updateThumbnails();
        }

        function removeRefImage(event, index) {
            event.preventDefault(); // Prevent triggering file input
            event.stopPropagation();
            refImages.splice(index, 1);
            updateThumbnails();
        }

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            // Reset input so same file can be selected again if deleted
            fileInput.value = ''; 
        });

        // Drag and Drop visual feedback
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-acid-yellow/20', 'border-black');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-acid-yellow/20', 'border-black');
        });

        // 6. Template Logic
        const templateRadios = document.querySelectorAll('input[name="template"]');
        const promptInput = document.getElementById('promptInput');

        templateRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const prompt = e.target.dataset.prompt;
                if (prompt) {
                    promptInput.value = prompt;
                    // Add highlight effect
                    promptInput.classList.add('bg-acid-yellow/20');
                    setTimeout(() => promptInput.classList.remove('bg-acid-yellow/20'), 300);
                } else {
                    // Clear prompt if None selected
                    promptInput.value = '';
                }
            });
        });

    </script>
